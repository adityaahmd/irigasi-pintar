<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Irrigation Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #10b981 100%);
            min-height: 100vh;
            color: white;
        }
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1.5rem;
        }
        .status-dot {
            height: 10px; width: 10px; border-radius: 50%; display: inline-block;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-5xl mx-auto">
        <header class="flex justify-between items-center mb-8 glass p-6">
            <div>
                <h1 class="text-2xl font-bold">Irigasi Pintar V3</h1>
                <p class="text-sm opacity-80" id="clock">Memuat waktu...</p>
            </div>
            <div class="text-right">
                <div class="flex items-center justify-end gap-2">
                    <span id="indicator" class="status-dot bg-gray-400"></span>
                    <span id="connText" class="font-semibold text-sm">Menghubungkan...</span>
                </div>
                <p class="text-[10px] uppercase tracking-widest opacity-60">Firebase Cloud System</p>
            </div>
        </header>

        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="glass p-6 text-center">
                <p class="text-xs uppercase opacity-70 mb-2">Suhu Udara</p>
                <h2 class="text-3xl font-bold" id="temp">--°C</h2>
            </div>
            <div class="glass p-6 text-center">
                <p class="text-xs uppercase opacity-70 mb-2">Tanah 1</p>
                <h2 class="text-3xl font-bold" id="soil">--%</h2>
            </div>
            <div class="glass p-6 text-center">
                <p class="text-xs uppercase opacity-70 mb-2">Kelembapan</p>
                <h2 class="text-3xl font-bold" id="hum">--%</h2>
            </div>
            <div class="glass p-6 text-center">
                <p class="text-xs uppercase opacity-70 mb-2">pH Tanah</p>
                <h2 class="text-3xl font-bold" id="ph">--</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="glass p-8">
                <h3 class="text-lg font-semibold mb-6 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    Kontrol Pompa Utama
                </h3>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="sendPump('ON')" id="btnOn" class="py-4 rounded-xl bg-white/10 hover:bg-white/20 border border-white/20 transition-all font-bold">NYALAKAN</button>
                    <button onclick="sendPump('OFF')" id="btnOff" class="py-4 rounded-xl bg-white/10 hover:bg-white/20 border border-white/20 transition-all font-bold">MATIKAN</button>
                </div>
                <p class="mt-4 text-center text-xs opacity-60" id="pumpStatus">Status saat ini: Memuat...</p>
            </div>

            <div class="glass p-8">
                <h3 class="text-lg font-semibold mb-6 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                    Kontrol Atap (Servo)
                </h3>
                <input type="range" min="0" max="180" value="90" 
                       class="w-full h-2 bg-white/20 rounded-lg appearance-none cursor-pointer accent-white"
                       onchange="sendServo(this.value)" id="servoRange">
                <div class="flex justify-between mt-4 text-sm font-bold">
                    <span>0°</span>
                    <span id="servoVal" class="text-xl bg-white/20 px-4 py-1 rounded-lg">90°</span>
                    <span>180°</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG - Pastikan URL ini sudah benar (asia-southeast1)
        const FB_URL = "https://myesp32control-a3605-default-rtdb.asia-southeast1.firebasedatabase.app/";

        // 1. Ambil Data (Monitoring)
        async function updateDashboard() {
            try {
                const response = await fetch(FB_URL + ".json");
                const data = await response.json();
                
                if (data) {
                    // Update Indikator Online
                    document.getElementById('indicator').className = "status-dot bg-green-400 shadow-[0_0_8px_#4ade80]";
                    document.getElementById('connText').innerText = "Cloud Online";

                    // Update Monitoring (sesuai folder /monitoring di ESP32)
                    const m = data.monitoring || {};
                    document.getElementById('temp').innerText = (m.temperature || 0).toFixed(1) + "°C";
                    document.getElementById('hum').innerText = (m.humidity || 0).toFixed(1) + "%";
                    document.getElementById('soil').innerText = (m.soil1 || 0) + "%";
                    document.getElementById('ph').innerText = (m.ph1 || 0).toFixed(1);

                    // Update Status Pompa
                    const pStatus = data.control ? data.control.pump1 : "OFF";
                    document.getElementById('pumpStatus').innerText = "Status saat ini: " + pStatus;
                    
                    // Style Tombol Aktif
                    document.getElementById('btnOn').className = pStatus === "ON" ? "py-4 rounded-xl bg-green-500 border-none font-bold shadow-lg" : "py-4 rounded-xl bg-white/10 border border-white/20 font-bold";
                    document.getElementById('btnOff').className = pStatus === "OFF" ? "py-4 rounded-xl bg-red-500 border-none font-bold shadow-lg" : "py-4 rounded-xl bg-white/10 border border-white/20 font-bold";
                }
            } catch (err) {
                document.getElementById('indicator').className = "status-dot bg-red-500";
                document.getElementById('connText').innerText = "Cloud Offline";
            }
        }

        // 2. Kirim Perintah (Control)
        async function sendPump(state) {
            try {
                await fetch(`${FB_URL}control/pump1.json`, {
                    method: 'PUT',
                    body: JSON.stringify(state)
                });
                updateDashboard();
            } catch (e) { alert("Gagal mengirim perintah"); }
        }

        async function sendServo(val) {
            document.getElementById('servoVal').innerText = val + "°";
            try {
                await fetch(`${FB_URL}control/roof_angle.json`, {
                    method: 'PUT',
                    body: JSON.stringify(parseInt(val))
                });
            } catch (e) { console.error(e); }
        }

        // Clock & Polling
        setInterval(() => {
            const n = new Date();
            document.getElementById('clock').innerText = n.toLocaleTimeString('id-ID');
        }, 1000);

        setInterval(updateDashboard, 3000);
        updateDashboard(); // Run pertama kali
    </script>
</body>
</html>
