<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sistem Irigasi - SIP V3 Cloud</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --font-main: 'Inter', sans-serif; --sidebar-width: 240px; }
        body { font-family: var(--font-main); background-color: #f3f4f6; color: #374151; }
        body.dark-mode { background-color: #1f2937; color: #f3f4f6; }
        .sidebar { width: var(--sidebar-width); transition: width 0.3s; overflow: hidden; white-space: nowrap; }
        .sidebar.collapsed { width: 70px; }
        .clean-card { background: white; border-radius: 12px; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.02); }
        body.dark-mode .clean-card { background: #374151; border: 1px solid #4b5563; }
        .btn-action { padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; transition: all 0.2s; border: 1px solid #e5e7eb; background: white; color: #374151; }
        .btn-action.active-black { background: #1f2937; color: white; border-color: #1f2937; }
        body.dark-mode .btn-action { background: #374151; color: #f3f4f6; border-color: #4b5563; }
        body.dark-mode .btn-action.active-black { background: #d1d5db; color: #1f2937; }
        .notification-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .notification { padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateX(400px); transition: 0.3s; }
        .notification.show { transform: translateX(0); }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <aside id="sidebar" class="sidebar bg-white border-r border-gray-200 flex flex-col z-20 dark:bg-gray-900 dark:border-gray-700">
        <div class="h-16 flex items-center px-6 border-b border-gray-100 dark:border-gray-800">
            <div class="w-8 h-8 bg-gray-800 rounded-lg flex items-center justify-center text-white font-bold">S</div>
            <span class="ml-3 font-bold text-lg tracking-tight dark:text-white">SIP <span class="font-normal text-gray-400">V3</span></span>
        </div>
        <nav class="flex-1 px-3 py-6 space-y-1">
            <button class="flex items-center w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-800 font-semibold dark:text-white">Dashboard</button>
        </nav>
        <div class="p-4 border-t border-gray-100 text-xs text-gray-400 text-center">&copy; 2026 Smart Irrigation</div>
    </aside>

    <div class="flex-1 flex flex-col h-full relative min-w-0">
        <header class="h-16 bg-white/90 backdrop-blur border-b border-gray-200 flex justify-between items-center px-4 dark:bg-gray-800 dark:border-gray-700">
            <div class="flex items-center gap-4">
                <h1 class="text-base md:text-lg font-bold dark:text-white">Dashboard Irigasi Pintar</h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center bg-gray-50 px-3 py-1.5 rounded-full border border-gray-100 dark:bg-gray-700 dark:border-gray-600">
                    <div id="connIndicator" class="w-2 h-2 rounded-full bg-gray-300 mr-2"></div>
                    <span id="connText" class="text-xs font-semibold text-gray-500 dark:text-gray-300">Offline</span>
                </div>
                <button onclick="document.body.classList.toggle('dark-mode')" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">ðŸŒ“</button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="clean-card p-4">
                    <p class="text-[10px] font-bold text-gray-400 uppercase">Suhu Udara</p>
                    <p id="tempValue" class="text-2xl font-bold text-gray-800 dark:text-white">--</p>
                    <span class="text-[10px] text-gray-400">Celcius (Â°C)</span>
                </div>
                <div class="clean-card p-4">
                    <p class="text-[10px] font-bold text-gray-400 uppercase">Kelembapan</p>
                    <p id="humValue" class="text-2xl font-bold text-gray-800 dark:text-white">--</p>
                    <span class="text-[10px] text-gray-400">Relatif (%)</span>
                </div>
                <div class="clean-card p-4">
                    <p class="text-[10px] font-bold text-gray-400 uppercase">Moisture Tanah</p>
                    <p id="soil1Value" class="text-2xl font-bold text-gray-800 dark:text-white">--</p>
                    <span class="text-[10px] text-gray-400">Soil 1 (%)</span>
                </div>
                <div class="clean-card p-4">
                    <p class="text-[10px] font-bold text-gray-400 uppercase">pH Larutan</p>
                    <p id="ph1Value" class="text-2xl font-bold text-gray-800 dark:text-white">--</p>
                    <span class="text-[10px] text-gray-400">pH 1</span>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="clean-card p-5">
                    <h3 class="text-sm font-bold text-gray-800 uppercase dark:text-white mb-4">Kontrol Pompa Utama</h3>
                    <div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg dark:bg-gray-800">
                        <span id="pump1Status" class="text-xs font-bold text-gray-500">STATUS: --</span>
                        <div class="flex gap-2">
                            <button id="btnPumpOn" onclick="sendControl('pump1', 'ON')" class="btn-action">ON</button>
                            <button id="btnPumpOff" onclick="sendControl('pump1', 'OFF')" class="btn-action">OFF</button>
                        </div>
                    </div>
                </div>
                <div class="clean-card p-5">
                    <h3 class="text-sm font-bold text-gray-800 uppercase dark:text-white mb-4">Kontrol Atap (Servo)</h3>
                    <input type="range" min="0" max="180" value="90" id="servoRange" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mb-2" onchange="sendControl('roof_angle', parseInt(this.value))">
                    <div class="flex justify-between text-[10px] font-bold text-gray-400 uppercase">
                        <span>Tutup (0Â°)</span>
                        <span id="servoValue" class="text-gray-800 dark:text-white">90Â°</span>
                        <span>Buka (180Â°)</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="notificationContainer" class="notification-container"></div>

    <script>
        // CONFIG SINKRONISASI ASIA-SOUTHEAST1
        const FB_URL = "https://myesp32control-a3605-default-rtdb.asia-southeast1.firebasedatabase.app/";

        async function updateDashboard() {
            try {
                const res = await fetch(FB_URL + ".json");
                const db = await res.json();
                if(!db) return;

                // Status Koneksi
                document.getElementById('connIndicator').className = "w-2 h-2 rounded-full bg-green-500 mr-2";
                document.getElementById('connText').innerText = "Cloud Online";

                // Update Monitoring Sensor
                const m = db.monitoring || {};
                document.getElementById('tempValue').innerText = (m.temperature || 0).toFixed(1);
                document.getElementById('humValue').innerText = (m.humidity || 0).toFixed(1);
                document.getElementById('soil1Value').innerText = (m.soil1 || 0);
                document.getElementById('ph1Value').innerText = (m.ph1 || 0).toFixed(1);

                // Update UI Control State
                const c = db.control || {};
                const p1 = c.pump1 || "OFF";
                document.getElementById('pump1Status').innerText = "STATUS: " + p1;
                document.getElementById('btnPumpOn').classList.toggle('active-black', p1 === "ON");
                document.getElementById('btnPumpOff').classList.toggle('active-black', p1 === "OFF");
                
                const roof = c.roof_angle || 90;
                document.getElementById('servoValue').innerText = roof + "Â°";
                if(document.activeElement.id !== "servoRange") {
                    document.getElementById('servoRange').value = roof;
                }

            } catch (e) {
                document.getElementById('connIndicator').className = "w-2 h-2 rounded-full bg-red-500 mr-2";
                document.getElementById('connText').innerText = "Offline";
            }
        }

        async function sendControl(target, value) {
            try {
                await fetch(`${FB_URL}control/${target}.json`, {
                    method: 'PUT',
                    body: JSON.stringify(value)
                });
                showNotification(`Berhasil: ${target} -> ${value}`, 'success');
                updateDashboard();
            } catch (e) {
                showNotification(`Gagal mengirim perintah!`, 'error');
            }
        }

        function showNotification(msg, type) {
            const container = document.getElementById('notificationContainer');
            const div = document.createElement('div');
            div.className = `notification show ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            div.innerText = msg;
            container.appendChild(div);
            setTimeout(() => { div.classList.remove('show'); setTimeout(() => div.remove(), 300); }, 3000);
        }

        setInterval(updateDashboard, 3000);
        updateDashboard();
    </script>
</body>
</html>
