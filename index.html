<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sistem Irigasi - Dashboard Cloud</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --font-main: 'Inter', sans-serif; --sidebar-width: 240px; }
        body { font-family: var(--font-main); background-color: #f3f4f6; color: #374151; transition: background 0.3s; }
        body.dark-mode { background-color: #1f2937; color: #f3f4f6; }
        .clean-card { background: white; border-radius: 12px; border: 1px solid #e5e7eb; padding: 1.25rem; }
        body.dark-mode .clean-card { background: #374151; border-color: #4b5563; }
        .btn-action { padding: 8px 16px; border-radius: 8px; border: 1px solid #e5e7eb; background: white; font-size: 13px; font-weight: 600; transition: 0.2s; }
        .btn-action.active-black { background: #1f2937; color: white; border-color: #1f2937; }
        body.dark-mode .btn-action { background: #4b5563; color: white; border-color: #6b7280; }
        body.dark-mode .btn-action.active-black { background: #f3f4f6; color: #1f2937; }
        .notification-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .notification { padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateX(400px); transition: 0.3s; }
        .notification.show { transform: translateX(0); }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <aside class="w-60 bg-white border-r border-gray-200 flex flex-col hidden md:flex dark:bg-gray-900 dark:border-gray-700">
        <div class="h-16 flex items-center px-6 border-b border-gray-100 dark:border-gray-800">
            <span class="font-bold text-lg text-gray-800 dark:text-white">SIP <span class="font-normal text-gray-400">V3</span></span>
        </div>
        <nav class="flex-1 px-4 py-6 space-y-2">
            <button class="flex items-center w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-800 font-semibold">Dashboard</button>
        </nav>
        <div class="p-4 text-xs text-gray-400 text-center">&copy; 2026 Smart Irrigation</div>
    </aside>

    <div class="flex-1 flex flex-col min-w-0">
        <header class="h-16 bg-white border-b border-gray-200 flex justify-between items-center px-6 dark:bg-gray-800 dark:border-gray-700">
            <h1 class="font-bold text-gray-800 dark:text-white">Sistem Irigasi Cloud</h1>
            <div class="flex items-center gap-4">
                <div class="flex items-center bg-gray-50 px-3 py-1.5 rounded-full border border-gray-100 dark:bg-gray-700 dark:border-gray-600">
                    <div id="connIndicator" class="w-2 h-2 rounded-full bg-gray-400 mr-2"></div>
                    <span id="connText" class="text-xs font-bold text-gray-500 dark:text-gray-300">Connecting...</span>
                </div>
                <button id="darkModeToggle" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700">ðŸŒ“</button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6 space-y-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="clean-card">
                    <p class="text-[10px] font-bold text-gray-400 uppercase">Suhu Udara</p>
                    <p id="tempValue" class="text-2xl font-bold text-gray-800 dark:text-white">--Â°C</p>
                </div>
                <div class="clean-card">
                    <p class="text-[10px] font-bold text-gray-400 uppercase">Tanah 1</p>
                    <p id="soil1Value" class="text-2xl font-bold text-gray-800 dark:text-white">--%</p>
                </div>
                <div class="clean-card">
                    <p class="text-[10px] font-bold text-gray-400 uppercase">pH Larutan</p>
                    <p id="ph1Value" class="text-2xl font-bold text-gray-800 dark:text-white">--</p>
                </div>
                <div class="clean-card">
                    <p class="text-[10px] font-bold text-gray-400 uppercase">Kelembapan</p>
                    <p id="humValue" class="text-2xl font-bold text-gray-800 dark:text-white">--%</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="clean-card">
                    <h3 class="text-sm font-bold mb-4 uppercase">Kontrol Pompa 1</h3>
                    <div class="flex gap-2">
                        <button onclick="setPumpState(1, 'ON')" class="btn-action w-full" id="p1On">ON</button>
                        <button onclick="setPumpState(1, 'OFF')" class="btn-action w-full" id="p1Off">OFF</button>
                    </div>
                </div>
                <div class="clean-card">
                    <h3 class="text-sm font-bold mb-4 uppercase">Atap (Servo)</h3>
                    <input type="range" min="0" max="180" value="90" class="w-full" onchange="setServo(this.value)">
                    <p class="text-center mt-2 font-bold" id="roofLabel">90Â°</p>
                </div>
            </div>
        </main>
    </div>

    <div id="notificationContainer" class="notification-container"></div>

    <script>
        // === PERBAIKAN URL (Mendukung Asia-Southeast1 Singapura) ===
        const FB_URL = "https://myesp32control-a3605-default-rtdb.asia-southeast1.firebasedatabase.app/";

        async function fetchData() {
            try {
                const res = await fetch(FB_URL + ".json");
                const db = await res.json();
                if(!db) return;

                // Update Status Koneksi
                document.getElementById('connIndicator').className = "w-2 h-2 rounded-full bg-green-500 mr-2";
                document.getElementById('connText').innerText = "Online";

                // Mapping Monitoring
                const m = db.monitoring || {};
                document.getElementById('tempValue').innerText = (m.temperature || 0).toFixed(1) + "Â°C";
                document.getElementById('soil1Value').innerText = (m.soil1 || 0) + "%";
                document.getElementById('ph1Value').innerText = (m.ph1 || 0).toFixed(1);
                document.getElementById('humValue').innerText = (m.humidity || 0) + "%";

                // Mapping Pump State UI
                const p1 = db.control ? db.control.pump1 : "OFF";
                document.getElementById('p1On').classList.toggle('active-black', p1 === "ON");
                document.getElementById('p1Off').classList.toggle('active-black', p1 === "OFF");

            } catch (e) {
                document.getElementById('connIndicator').className = "w-2 h-2 rounded-full bg-red-500 mr-2";
                document.getElementById('connText').innerText = "Offline";
            }
        }

        async function setPumpState(num, state) {
            await fetch(`${FB_URL}control/pump${num}.json`, {
                method: 'PUT',
                body: JSON.stringify(state)
            });
            showNotify(`Pompa ${num} diubah ke ${state}`, 'bg-green-500');
        }

        async function setServo(val) {
            document.getElementById('roofLabel').innerText = val + "Â°";
            await fetch(`${FB_URL}control/roof_angle.json`, {
                method: 'PUT',
                body: JSON.stringify(parseInt(val))
            });
        }

        function showNotify(msg, color) {
            const container = document.getElementById('notificationContainer');
            const div = document.createElement('div');
            div.className = `notification show ${color}`;
            div.innerText = msg;
            container.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        document.getElementById('darkModeToggle').onclick = () => document.body.classList.toggle('dark-mode');
        
        setInterval(fetchData, 3000);
        fetchData();
    </script>
</body>
</html>
